Ext.namespace("Ext.ux.grid.livegrid");Ext.ux.grid.livegrid.DragZone=function(grid,config){Ext.ux.grid.livegrid.DragZone.superclass.constructor.call(this,grid,config);this.view.ds.on("beforeselectionsload",this._onBeforeSelectionsLoad,this);this.view.ds.on("selectionsload",this._onSelectionsLoad,this)};Ext.extend(Ext.ux.grid.livegrid.DragZone,Ext.grid.GridDragZone,{isDropValid:true,onInitDrag:function(e){this.view.ds.loadSelections(this.grid.selModel.getPendingSelections(true));Ext.ux.grid.livegrid.DragZone.superclass.onInitDrag.call(this,e)},_onBeforeSelectionsLoad:function(){this.isDropValid=false;Ext.fly(this.proxy.el.dom.firstChild).addClass("ext-ux-livegrid-drop-waiting")},_onSelectionsLoad:function(){this.isDropValid=true;this.ddel.innerHTML=this.grid.getDragDropText();Ext.fly(this.proxy.el.dom.firstChild).removeClass("ext-ux-livegrid-drop-waiting")}});Ext.namespace("Ext.ux.grid.livegrid");Ext.ux.grid.livegrid.EditorGridPanel=Ext.extend(Ext.grid.EditorGridPanel,{initEvents:function(){Ext.ux.grid.livegrid.EditorGridPanel.superclass.initEvents.call(this);this.view.on("cursormove",this.stopEditing,this,[true])},startEditing:function(row,col){this.stopEditing();if(this.colModel.isCellEditable(col,row)){this.view.ensureVisible(row,col,true);if(!this.store.getAt(row)){return}}return Ext.ux.grid.livegrid.EditorGridPanel.superclass.startEditing.call(this,row,col)},walkCells:function(row,col,step,fn,scope){return Ext.ux.grid.livegrid.GridPanel.prototype.walkCells.call(this,row,col,step,fn,scope)},onRender:function(ct,position){return Ext.ux.grid.livegrid.GridPanel.prototype.onRender.call(this,ct,position)}});Ext.namespace("Ext.ux.grid.livegrid");Ext.ux.grid.livegrid.GridPanel=Ext.extend(Ext.grid.GridPanel,{onRender:function(ct,position){Ext.ux.grid.livegrid.GridPanel.superclass.onRender.call(this,ct,position);var ds=this.getStore();if(ds._autoLoad===true){delete ds._autoLoad;ds.load()}},walkCells:function(row,col,step,fn,scope){var ds=this.store;var _oF=ds.getCount;ds.getCount=ds.getTotalCount;var ret=Ext.ux.grid.livegrid.GridPanel.superclass.walkCells.call(this,row,col,step,fn,scope);ds.getCount=_oF;return ret}});Ext.namespace("Ext.ux.grid.livegrid");Ext.ux.grid.livegrid.Toolbar=Ext.extend(Ext.Toolbar,{displayMsg:"Displaying {0} - {1} of {2}",emptyMsg:"No data to display",refreshText:"Refresh",initComponent:function(){Ext.ux.grid.livegrid.Toolbar.superclass.initComponent.call(this);if(this.grid){this.view=this.grid.getView()}var me=this;this.view.init=this.view.init.createSequence(function(){me.bind(this)},this.view)},updateInfo:function(rowIndex,visibleRows,totalCount){if(this.displayEl){var msg=totalCount==0?this.emptyMsg:String.format(this.displayMsg,rowIndex+1,rowIndex+visibleRows,totalCount);this.displayEl.update(msg)}},unbind:function(view){var st;var vw;if(view instanceof Ext.grid.GridView){vw=view}else{vw=view.getView()}st=view.ds;st.un("loadexception",this.enableLoading,this);st.un("beforeload",this.disableLoading,this);st.un("load",this.enableLoading,this);vw.un("rowremoved",this.onRowRemoved,this);vw.un("rowsinserted",this.onRowsInserted,this);vw.un("beforebuffer",this.beforeBuffer,this);vw.un("cursormove",this.onCursorMove,this);vw.un("buffer",this.onBuffer,this);vw.un("bufferfailure",this.enableLoading,this);this.view=undefined},bind:function(view){this.view=view;var st=view.ds;st.on("loadexception",this.enableLoading,this);st.on("beforeload",this.disableLoading,this);st.on("load",this.enableLoading,this);view.on("rowremoved",this.onRowRemoved,this);view.on("rowsinserted",this.onRowsInserted,this);view.on("beforebuffer",this.beforeBuffer,this);view.on("cursormove",this.onCursorMove,this);view.on("buffer",this.onBuffer,this);view.on("bufferfailure",this.enableLoading,this)},enableLoading:function(){this.loading.setDisabled(false)},disableLoading:function(){this.loading.setDisabled(true)},onCursorMove:function(view,rowIndex,visibleRows,totalCount){this.updateInfo(rowIndex,visibleRows,totalCount)},onRowsInserted:function(view,start,end){this.updateInfo(view.rowIndex,Math.min(view.ds.totalLength,view.visibleRows-view.rowClipped),view.ds.totalLength)},onRowRemoved:function(view,index,record){this.updateInfo(view.rowIndex,Math.min(view.ds.totalLength,view.visibleRows-view.rowClipped),view.ds.totalLength)},beforeBuffer:function(view,store,rowIndex,visibleRows,totalCount,options){this.loading.disable();this.updateInfo(rowIndex,visibleRows,totalCount)},onBuffer:function(view,store,rowIndex,visibleRows,totalCount){this.loading.enable();this.updateInfo(rowIndex,visibleRows,totalCount)},onClick:function(type){switch(type){case"refresh":if(this.view.reset(true)){this.loading.disable()}else{this.loading.enable()}break}},onRender:function(ct,position){Ext.PagingToolbar.superclass.onRender.call(this,ct,position);this.loading=this.addButton({tooltip:this.refreshText,iconCls:"x-tbar-loading",handler:this.onClick.createDelegate(this,["refresh"])});this.addSeparator();if(this.displayInfo){this.displayEl=Ext.fly(this.el.dom).createChild({cls:"x-paging-info"})}}});Ext.namespace("Ext.ux.grid.livegrid");Ext.ux.grid.livegrid.GridView=function(config){this.addEvents({beforebuffer:true,buffer:true,bufferfailure:true,cursormove:true});this.horizontalScrollOffset=17;Ext.apply(this,config);this.templates={};this.templates.master=new Ext.Template('<div class="x-grid3" hidefocus="true"><div class="ext-ux-livegrid-liveScroller"><div></div></div>','<div class="x-grid3-viewport"">','<div class="x-grid3-header"><div class="x-grid3-header-inner"><div class="x-grid3-header-offset">{header}</div></div><div class="x-clear"></div></div>','<div class="x-grid3-scroller" style="overflow-y:hidden !important;"><div class="x-grid3-body">{body}</div><a href="#" class="x-grid3-focus" tabIndex="-1"></a></div>',"</div>",'<div class="x-grid3-resize-marker">&#160;</div>','<div class="x-grid3-resize-proxy">&#160;</div>',"</div>");this._gridViewSuperclass=Ext.ux.grid.livegrid.GridView.superclass;this._gridViewSuperclass.constructor.call(this)};Ext.extend(Ext.ux.grid.livegrid.GridView,Ext.grid.GridView,{_maskIndex:20001,hdHeight:0,rowClipped:0,liveScroller:null,liveScrollerInset:null,rowHeight:-1,visibleRows:1,lastIndex:-1,lastRowIndex:0,lastScrollPos:0,rowIndex:0,isBuffering:false,requestQueue:-1,loadMask:false,isPrebuffering:false,_loadMaskAnchor:null,reset:function(forceReload){if(forceReload===false){this.ds.modified=[];this.rowIndex=0;this.lastScrollPos=0;this.lastRowIndex=0;this.lastIndex=0;this.adjustVisibleRows();this.adjustScrollerPos(-this.liveScroller.dom.scrollTop,true);this.showLoadMask(false);this.refresh(true);this.fireEvent("cursormove",this,0,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength);return false}else{var params={};var sInfo=this.ds.sortInfo;if(sInfo){params={dir:sInfo.direction,sort:sInfo.field}}return this.ds.load({params:params})}},renderUI:function(){var g=this.grid;var dEnabled=g.enableDragDrop||g.enableDrag;g.enableDragDrop=false;g.enableDrag=false;this._gridViewSuperclass.renderUI.call(this);var g=this.grid;g.enableDragDrop=dEnabled;g.enableDrag=dEnabled;if(dEnabled){this.dragZone=new Ext.ux.grid.livegrid.DragZone(g,{ddGroup:g.ddGroup||"GridDD"})}if(this.loadMask){this._loadMaskAnchor=Ext.get(this.mainBody.dom.parentNode.parentNode);Ext.apply(this.loadMask,{msgCls:"x-mask-loading"});this._loadMaskAnchor.mask(this.loadMask.msg,this.loadMask.msgCls);this._loadMaskAnchor._mask.addClass("ext-ux-livegrid");this._loadMaskAnchor._mask.setDisplayed(false);this._loadMaskAnchor._maskMsg.setDisplayed(false)}},init:function(grid){this._gridViewSuperclass.init.call(this,grid);grid.on("expand",this._onExpand,this)},initData:function(ds,cm){if(this.ds){this.ds.un("bulkremove",this.onBulkRemove,this);this.ds.un("beforeload",this.onBeforeLoad,this)}if(ds){ds.on("bulkremove",this.onBulkRemove,this);ds.on("beforeload",this.onBeforeLoad,this)}this._gridViewSuperclass.initData.call(this,ds,cm)},renderBody:function(){var markup=this.renderRows(0,this.visibleRows-1);return this.templates.body.apply({rows:markup})},doRender:function(cs,rs,ds,startRow,colCount,stripe){return this._gridViewSuperclass.doRender.call(this,cs,rs,ds,startRow+this.ds.bufferRange[0],colCount,stripe)},initElements:function(){var E=Ext.Element;var el=this.grid.getGridEl().dom.firstChild;var cs=el.childNodes;this.el=new E(el);this.mainWrap=new E(cs[1]);this.liveScroller=new E(cs[0]);this.liveScrollerInset=this.liveScroller.dom.firstChild;this.liveScroller.on("scroll",this.onLiveScroll,this,{buffer:this.scrollDelay});var thd=this.mainWrap.dom.firstChild;this.mainHd=new E(thd);this.hdHeight=thd.offsetHeight;this.innerHd=this.mainHd.dom.firstChild;this.scroller=new E(this.mainWrap.dom.childNodes[1]);if(this.forceFit){this.scroller.setStyle("overflow-x","hidden")}this.mainBody=new E(this.scroller.dom.firstChild);this.mainBody.on("mousewheel",this.handleWheel,this);this.focusEl=new E(this.scroller.dom.childNodes[1]);this.focusEl.swallowEvent("click",true);this.resizeMarker=new E(cs[2]);this.resizeProxy=new E(cs[3])},layout:function(){if(!this.mainBody){return}var g=this.grid;var c=g.getGridEl(),cm=this.cm,expandCol=g.autoExpandColumn,gv=this;var csize=c.getSize(true);var vw=csize.width;if(vw<20||csize.height<20){return}if(g.autoHeight){this.scroller.dom.style.overflow="visible"}else{this.el.setSize(csize.width,csize.height);var hdHeight=this.mainHd.getHeight();var vh=csize.height-(hdHeight);this.scroller.setSize(vw,vh);if(this.innerHd){this.innerHd.style.width=(vw)+"px"}}this.liveScroller.dom.style.top=this.hdHeight+"px";if(this.forceFit){if(this.lastViewWidth!=vw){this.fitColumns(false,false);this.lastViewWidth=vw}}else{this.autoExpand()}this.adjustVisibleRows();this.adjustBufferInset();this.onLayout(vw,vh)},removeRow:function(row){Ext.removeNode(this.getRow(row))},removeRows:function(firstRow,lastRow){var bd=this.mainBody.dom;for(var rowIndex=firstRow;rowIndex<=lastRow;rowIndex++){Ext.removeNode(bd.childNodes[firstRow])}},_onExpand:function(panel){this.adjustVisibleRows();this.adjustBufferInset();this.adjustScrollerPos(this.rowHeight*this.rowIndex,true)},onColumnMove:function(cm,oldIndex,newIndex){this.indexMap=null;this.replaceLiveRows(this.rowIndex,true);this.updateHeaders();this.updateHeaderSortState();this.afterMove(newIndex)},onColumnWidthUpdated:function(col,w,tw){this.adjustVisibleRows();this.adjustBufferInset()},onAllColumnWidthsUpdated:function(ws,tw){this.adjustVisibleRows();this.adjustBufferInset()},onRowSelect:function(row){if(row<this.rowIndex||row>this.rowIndex+this.visibleRows){return}this.addRowClass(row,"x-grid3-row-selected")},onRowDeselect:function(row){if(row<this.rowIndex||row>this.rowIndex+this.visibleRows){return}this.removeRowClass(row,"x-grid3-row-selected")},onClear:function(){this.reset(false)},onBulkRemove:function(store,removedData){var record=null;var index=0;var viewIndex=0;var len=removedData.length;var removedInView=false;var removedAfterView=false;var scrollerAdjust=0;if(len==0){return}var tmpRowIndex=this.rowIndex;var removedBefore=0;var removedAfter=0;var removedIn=0;for(var i=0;i<len;i++){record=removedData[i][0];index=removedData[i][1];viewIndex=(index!=Number.MIN_VALUE&&index!=Number.MAX_VALUE)?index+this.ds.bufferRange[0]:index;if(viewIndex<this.rowIndex){removedBefore++}else{if(viewIndex>=this.rowIndex&&viewIndex<=this.rowIndex+(this.visibleRows-1)){removedIn++}else{if(viewIndex>=this.rowIndex+this.visibleRows){removedAfter++}}}this.fireEvent("beforerowremoved",this,viewIndex,record);this.fireEvent("rowremoved",this,viewIndex,record)}var totalLength=this.ds.totalLength;this.rowIndex=Math.max(0,Math.min(this.rowIndex-removedBefore,totalLength-(this.visibleRows-1)));this.lastRowIndex=this.rowIndex;this.adjustScrollerPos(-(removedBefore*this.rowHeight),true);this.updateLiveRows(this.rowIndex,true);this.adjustBufferInset();this.processRows(0,undefined,false)},onRemove:function(ds,record,index){this.onBulkRemove(ds,[[record,index]])},onAdd:function(ds,records,index){var recordLen=records.length;if(index==Number.MAX_VALUE||index==Number.MIN_VALUE){this.fireEvent("beforerowsinserted",this,index,index);if(index==Number.MIN_VALUE){this.rowIndex=this.rowIndex+recordLen;this.lastRowIndex=this.rowIndex;this.adjustBufferInset();this.adjustScrollerPos(this.rowHeight*recordLen,true);this.fireEvent("rowsinserted",this,index,index,recordLen);this.processRows(0,undefined,false);this.fireEvent("cursormove",this,this.rowIndex,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength);return}this.adjustBufferInset();this.fireEvent("rowsinserted",this,index,index,recordLen);return}var start=index+this.ds.bufferRange[0];var end=start+(recordLen-1);var len=this.getRows().length;var firstRow=0;var lastRow=0;if(start>this.rowIndex+(this.visibleRows-1)){this.fireEvent("beforerowsinserted",this,start,end);this.fireEvent("rowsinserted",this,start,end,recordLen);this.adjustVisibleRows();this.adjustBufferInset()}else{if(start>=this.rowIndex&&start<=this.rowIndex+(this.visibleRows-1)){firstRow=index;lastRow=index+(recordLen-1);this.lastRowIndex=this.rowIndex;this.rowIndex=(start>this.rowIndex)?this.rowIndex:start;this.insertRows(ds,firstRow,lastRow);if(this.lastRowIndex!=this.rowIndex){this.fireEvent("cursormove",this,this.rowIndex,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength)}this.adjustVisibleRows();this.adjustBufferInset()}else{if(start<this.rowIndex){this.fireEvent("beforerowsinserted",this,start,end);this.rowIndex=this.rowIndex+recordLen;this.lastRowIndex=this.rowIndex;this.adjustVisibleRows();this.adjustBufferInset();this.adjustScrollerPos(this.rowHeight*recordLen,true);this.fireEvent("rowsinserted",this,start,end,recordLen);this.processRows(0,undefined,true);this.fireEvent("cursormove",this,this.rowIndex,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength)}}}},onBeforeLoad:function(store,options){if(!options.params){options.params={start:0,limit:this.ds.bufferSize}}else{options.params.start=0;options.params.limit=this.ds.bufferSize}options.scope=this;options.callback=function(){this.reset(false)};return true},onLoad:function(o1,o2,options){this.adjustBufferInset()},onDataChange:function(store){this.updateHeaderSortState()},liveBufferUpdate:function(records,options,success){if(success===true){this.adjustBufferInset();this.fireEvent("buffer",this,this.ds,this.rowIndex,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength,options);this.isBuffering=false;this.isPrebuffering=false;this.showLoadMask(false);this.grid.selModel.replaceSelections(records);if(this.isInRange(this.rowIndex)){this.replaceLiveRows(this.rowIndex,options.forceRepaint)}else{this.updateLiveRows(this.rowIndex)}if(this.requestQueue>=0){var offset=this.requestQueue;this.requestQueue=-1;this.updateLiveRows(offset)}return}else{this.fireEvent("bufferfailure",this,this.ds,options)}this.requestQueue=-1;this.isBuffering=false;this.isPrebuffering=false;this.showLoadMask(false)},handleWheel:function(e){if(this.rowHeight==-1){e.stopEvent();return}var d=e.getWheelDelta();this.adjustScrollerPos(-(d*this.rowHeight));e.stopEvent()},onLiveScroll:function(){var scrollTop=this.liveScroller.dom.scrollTop;var cursor=Math.floor((scrollTop)/this.rowHeight);this.rowIndex=cursor;if(cursor==this.lastRowIndex){return}this.updateLiveRows(cursor);this.lastScrollPos=this.liveScroller.dom.scrollTop},refreshRow:function(record){var ds=this.ds,index;if(typeof record=="number"){index=record;record=ds.getAt(index)}else{index=ds.indexOf(record)}var viewIndex=index+this.ds.bufferRange[0];if(viewIndex<this.rowIndex||viewIndex>=this.rowIndex+this.visibleRows){this.fireEvent("rowupdated",this,viewIndex,record);return}this.insertRows(ds,index,index,true);this.fireEvent("rowupdated",this,viewIndex,record)},processRows:function(startRow,skipStripe,paintSelections){skipStripe=skipStripe||!this.grid.stripeRows;startRow=0;var rows=this.getRows();var cls=" x-grid3-row-alt ";var cursor=this.rowIndex;var index=0;var selections=this.grid.selModel.selections;var ds=this.ds;var row=null;for(var i=startRow,len=rows.length;i<len;i++){index=i+cursor;row=rows[i];row.rowIndex=index;if(paintSelections!==false){if(this.grid.selModel.isSelected(this.ds.getAt(index))===true){this.addRowClass(index,"x-grid3-row-selected")}else{this.removeRowClass(index,"x-grid3-row-selected")}this.fly(row).removeClass("x-grid3-row-over")}if(!skipStripe){var isAlt=((index+1)%2==0);var hasAlt=(" "+row.className+" ").indexOf(cls)!=-1;if(isAlt==hasAlt){continue}if(isAlt){row.className+=" x-grid3-row-alt"}else{row.className=row.className.replace("x-grid3-row-alt","")}}}},insertRows:function(dm,firstRow,lastRow,isUpdate){var viewIndexFirst=firstRow+this.ds.bufferRange[0];var viewIndexLast=lastRow+this.ds.bufferRange[0];if(!isUpdate){this.fireEvent("beforerowsinserted",this,viewIndexFirst,viewIndexLast)}if(isUpdate!==true&&(this.getRows().length+(lastRow-firstRow))>=this.visibleRows){this.removeRows((this.visibleRows-1)-(lastRow-firstRow),this.visibleRows-1)}else{if(isUpdate){this.removeRows(viewIndexFirst-this.rowIndex,viewIndexLast-this.rowIndex)}}var lastRenderRow=(firstRow==lastRow)?lastRow:Math.min(lastRow,(this.rowIndex-this.ds.bufferRange[0])+(this.visibleRows-1));var html=this.renderRows(firstRow,lastRenderRow);var before=this.getRow(viewIndexFirst);if(before){Ext.DomHelper.insertHtml("beforeBegin",before,html)}else{Ext.DomHelper.insertHtml("beforeEnd",this.mainBody.dom,html)}if(isUpdate===true){var rows=this.getRows();var cursor=this.rowIndex;for(var i=0,max_i=rows.length;i<max_i;i++){rows[i].rowIndex=cursor+i}}if(!isUpdate){this.fireEvent("rowsinserted",this,viewIndexFirst,viewIndexLast,(viewIndexLast-viewIndexFirst)+1);this.processRows(0,undefined,true)}},getRow:function(row){if(row-this.rowIndex<0){return null}return this.getRows()[row-this.rowIndex]},getCell:function(row,col){var row=this.getRow(row);return row?row.getElementsByTagName("td")[col]:null},focusCell:function(row,col,hscroll){var xy=this.ensureVisible(row,col,hscroll);if(!xy){return}this.focusEl.setXY(xy);if(Ext.isGecko){this.focusEl.focus()}else{this.focusEl.focus.defer(1,this.focusEl)}},ensureVisible:function(row,col,hscroll){if(typeof row!="number"){row=row.rowIndex}if(row<0||row>=this.ds.totalLength){return}col=(col!==undefined?col:0);var rowInd=row-this.rowIndex;if(this.rowClipped&&row==this.rowIndex+this.visibleRows-1){this.adjustScrollerPos(this.rowHeight)}else{if(row>=this.rowIndex+this.visibleRows){this.adjustScrollerPos(((row-(this.rowIndex+this.visibleRows))+1)*this.rowHeight)}else{if(row<=this.rowIndex){this.adjustScrollerPos((rowInd)*this.rowHeight)}}}var rowEl=this.getRow(row),cellEl;if(!rowEl){return}if(!(hscroll===false&&col===0)){while(this.cm.isHidden(col)){col++}cellEl=this.getCell(row,col)}var c=this.scroller.dom;if(hscroll!==false){var cleft=parseInt(cellEl.offsetLeft,10);var cright=cleft+cellEl.offsetWidth;var sleft=parseInt(c.scrollLeft,10);var sright=sleft+c.clientWidth;if(cleft<sleft){c.scrollLeft=cleft}else{if(cright>sright){c.scrollLeft=cright-c.clientWidth}}}return cellEl?Ext.fly(cellEl).getXY():[c.scrollLeft+this.el.getX(),Ext.fly(rowEl).getY()]},isRecordRendered:function(record){var ind=this.ds.indexOf(record);if(ind>=this.rowIndex&&ind<this.rowIndex+this.visibleRows){return true}return false},isInRange:function(rowIndex){var lastRowIndex=Math.min(this.ds.totalLength-1,rowIndex+(this.visibleRows-1));return(rowIndex>=this.ds.bufferRange[0])&&(lastRowIndex<=this.ds.bufferRange[1])},getPredictedBufferIndex:function(index,inRange,down){if(!inRange){if(index+this.ds.bufferSize>=this.ds.totalLength){return this.ds.totalLength-this.ds.bufferSize}return Math.max(0,(index+this.visibleRows)-Math.round(this.ds.bufferSize/2))}if(!down){return Math.max(0,(index-this.ds.bufferSize)+this.visibleRows)}if(down){return Math.max(0,Math.min(index,this.ds.totalLength-this.ds.bufferSize))}},updateLiveRows:function(index,forceRepaint,forceReload){var inRange=this.isInRange(index);if(this.isBuffering){if(this.isPrebuffering){if(inRange){this.replaceLiveRows(index,forceRepaint)}else{this.showLoadMask(true)}}this.fireEvent("cursormove",this,index,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength);this.requestQueue=index;return}var lastIndex=this.lastIndex;this.lastIndex=index;var inRange=this.isInRange(index);var down=false;if(inRange&&forceReload!==true){this.replaceLiveRows(index,forceRepaint);this.fireEvent("cursormove",this,index,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength);if(index>lastIndex){down=true;var totalCount=this.ds.totalLength;if(index+this.visibleRows+this.nearLimit<=this.ds.bufferRange[1]){return}if(this.ds.bufferRange[1]+1>=totalCount){return}}else{if(index<lastIndex){down=false;if(this.ds.bufferRange[0]<=0){return}if(index-this.nearLimit>this.ds.bufferRange[0]){return}}else{return}}this.isPrebuffering=true}this.isBuffering=true;var bufferOffset=this.getPredictedBufferIndex(index,inRange,down);if(!inRange){this.showLoadMask(true)}this.ds.suspendEvents();var sInfo=this.ds.sortInfo;var params={};if(this.ds.lastOptions){Ext.apply(params,this.ds.lastOptions.params)}params.start=bufferOffset;params.limit=this.ds.bufferSize;if(sInfo){params.dir=sInfo.direction;params.sort=sInfo.field}var opts={forceRepaint:forceRepaint,callback:this.liveBufferUpdate,scope:this,params:params,suspendLoadEvent:true};this.fireEvent("beforebuffer",this,this.ds,index,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength,opts);this.ds.load(opts);this.ds.resumeEvents()},showLoadMask:function(show){if(!this.loadMask){return}var mask=this._loadMaskAnchor._mask;var maskMsg=this._loadMaskAnchor._maskMsg;if(show){mask.setDisplayed(true);maskMsg.setDisplayed(true);maskMsg.center(this._loadMaskAnchor);if(Ext.isIE&&!(Ext.isIE7&&Ext.isStrict)&&this._loadMaskAnchor.getStyle("height")=="auto"){mask.setSize(undefined,this._loadMaskAnchor.getHeight())}}else{mask.setDisplayed(false);maskMsg.setDisplayed(false)}},replaceLiveRows:function(cursor,forceReplace,processRows){var spill=cursor-this.lastRowIndex;if(spill==0&&forceReplace!==true){return}var append=spill>0;spill=Math.abs(spill);var bufferRange=this.ds.bufferRange;var cursorBuffer=cursor-bufferRange[0];var lpIndex=Math.min(cursorBuffer+this.visibleRows-1,bufferRange[1]-bufferRange[0]);if(spill>=this.visibleRows||spill==0){this.mainBody.update(this.renderRows(cursorBuffer,lpIndex))}else{if(append){this.removeRows(0,spill-1);if(cursorBuffer+this.visibleRows-spill<=bufferRange[1]-bufferRange[0]){var html=this.renderRows(cursorBuffer+this.visibleRows-spill,lpIndex);Ext.DomHelper.insertHtml("beforeEnd",this.mainBody.dom,html)}}else{this.removeRows(this.visibleRows-spill,this.visibleRows-1);var html=this.renderRows(cursorBuffer,cursorBuffer+spill-1);Ext.DomHelper.insertHtml("beforeBegin",this.mainBody.dom.firstChild,html)}}if(processRows!==false){this.processRows(0,undefined,true)}this.lastRowIndex=cursor},adjustBufferInset:function(){var liveScrollerDom=this.liveScroller.dom;var g=this.grid,ds=g.store;var c=g.getGridEl();var elWidth=c.getSize().width;var hiddenRows=(ds.totalLength==this.visibleRows-this.rowClipped)?0:Math.max(0,ds.totalLength-(this.visibleRows-this.rowClipped));if(hiddenRows==0){this.scroller.setWidth(elWidth);liveScrollerDom.style.display="none";return}else{this.scroller.setWidth(elWidth-this.scrollOffset);liveScrollerDom.style.display=""}var scrollbar=this.cm.getTotalWidth()+this.scrollOffset>elWidth;var contHeight=liveScrollerDom.parentNode.offsetHeight+((ds.totalLength>0&&scrollbar)?-this.horizontalScrollOffset:0)-this.hdHeight;liveScrollerDom.style.height=Math.max(contHeight,this.horizontalScrollOffset*2)+"px";if(this.rowHeight==-1){return}this.liveScrollerInset.style.height=(hiddenRows==0?0:contHeight+(hiddenRows*this.rowHeight))+"px"},adjustVisibleRows:function(){if(this.rowHeight==-1){if(this.getRows()[0]){this.rowHeight=this.getRows()[0].offsetHeight;if(this.rowHeight<=0){this.rowHeight=-1;return}}else{return}}var g=this.grid,ds=g.store;var c=g.getGridEl();var cm=this.cm;var size=c.getSize();var width=size.width;var vh=size.height;var vw=width-this.scrollOffset;if(cm.getTotalWidth()>vw){vh-=this.horizontalScrollOffset}vh-=this.mainHd.getHeight();var totalLength=ds.totalLength||0;var visibleRows=Math.max(1,Math.floor(vh/this.rowHeight));this.rowClipped=0;if(totalLength>visibleRows&&this.rowHeight/3<(vh-(visibleRows*this.rowHeight))){visibleRows=Math.min(visibleRows+1,totalLength);this.rowClipped=1}if(this.visibleRows==visibleRows){return}this.visibleRows=visibleRows;if(this.isBuffering&&!this.isPrebuffering){return}if(this.rowIndex+(visibleRows-this.rowClipped)>totalLength){this.rowIndex=Math.max(0,totalLength-(visibleRows-this.rowClipped));this.lastRowIndex=this.rowIndex}this.updateLiveRows(this.rowIndex,true)},adjustScrollerPos:function(pixels,suspendEvent){if(pixels==0){return}var liveScroller=this.liveScroller;var scrollDom=liveScroller.dom;if(suspendEvent===true){liveScroller.un("scroll",this.onLiveScroll,this)}this.lastScrollPos=scrollDom.scrollTop;scrollDom.scrollTop+=pixels;if(suspendEvent===true){scrollDom.scrollTop=scrollDom.scrollTop;liveScroller.on("scroll",this.onLiveScroll,this,{buffer:this.scrollDelay})}}});Ext.namespace("Ext.ux.grid.livegrid");Ext.ux.grid.livegrid.JsonReader=function(meta,recordType){Ext.ux.grid.livegrid.JsonReader.superclass.constructor.call(this,meta,recordType)};Ext.extend(Ext.ux.grid.livegrid.JsonReader,Ext.data.JsonReader,{readRecords:function(o){var s=this.meta;if(!this.ef&&s.versionProperty){this.getVersion=this.getJsonAccessor(s.versionProperty)}if(!this.__readRecords){this.__readRecords=Ext.ux.grid.livegrid.JsonReader.superclass.readRecords}var intercept=this.__readRecords.call(this,o);if(s.versionProperty){var v=this.getVersion(o);intercept.version=(v===undefined||v==="")?null:v}return intercept}});Ext.namespace("Ext.ux.grid.livegrid");Ext.ux.grid.livegrid.RowSelectionModel=function(config){this.addEvents({selectiondirty:true});Ext.apply(this,config);this.pendingSelections={};Ext.ux.grid.livegrid.RowSelectionModel.superclass.constructor.call(this)};Ext.extend(Ext.ux.grid.livegrid.RowSelectionModel,Ext.grid.RowSelectionModel,{initEvents:function(){Ext.ux.grid.livegrid.RowSelectionModel.superclass.initEvents.call(this);this.grid.view.on("rowsinserted",this.onAdd,this);this.grid.store.on("selectionsload",this.onSelectionsLoad,this)},onRemove:function(v,index,r){var ranges=this.getPendingSelections();var rangesLength=ranges.length;var selectionChanged=false;if(index==Number.MIN_VALUE||index==Number.MAX_VALUE){if(r){if(this.isIdSelected(r.id)&&index==Number.MIN_VALUE){this.shiftSelections(this.grid.store.bufferRange[1],-1)}this.selections.remove(r);selectionChanged=true}if(index==Number.MIN_VALUE){this.clearPendingSelections(0,this.grid.store.bufferRange[0])}else{this.clearPendingSelections(this.grid.store.bufferRange[1])}if(rangesLength!=0){this.fireEvent("selectiondirty",this,index,1)}}else{selectionChanged=this.isIdSelected(r.id);if(!selectionChanged){return}this.selections.remove(r);if(rangesLength!=0){var startRange=ranges[0];var endRange=ranges[rangesLength-1];if(index<=endRange||index<=startRange){this.shiftSelections(index,-1);this.fireEvent("selectiondirty",this,index,1)}}}if(selectionChanged){this.fireEvent("selectionchange",this)}},onAdd:function(store,index,endIndex,recordLength){var ranges=this.getPendingSelections();var rangesLength=ranges.length;if((index==Number.MIN_VALUE||index==Number.MAX_VALUE)){if(index==Number.MIN_VALUE){this.clearPendingSelections(0,this.grid.store.bufferRange[0]);this.shiftSelections(this.grid.store.bufferRange[1],recordLength)}else{this.clearPendingSelections(this.grid.store.bufferRange[1])}if(rangesLength!=0){this.fireEvent("selectiondirty",this,index,r)}return}var startRange=ranges[0];var endRange=ranges[rangesLength-1];var viewIndex=index;if(viewIndex<=endRange||viewIndex<=startRange){this.fireEvent("selectiondirty",this,viewIndex,recordLength);this.shiftSelections(viewIndex,recordLength)}},shiftSelections:function(startRow,length){var index=0;var newIndex=0;var newRequests={};var ds=this.grid.store;var storeIndex=startRow-ds.bufferRange[0];var newStoreIndex=0;var totalLength=this.grid.store.totalLength;var rec=null;var ranges=this.getPendingSelections();var rangesLength=ranges.length;if(rangesLength==0){return}for(var i=0;i<rangesLength;i++){index=ranges[i];if(index<startRow){continue}newIndex=index+length;newStoreIndex=storeIndex+length;if(newIndex>=totalLength){break}rec=ds.getAt(newStoreIndex);if(rec){this.selections.add(rec)}else{newRequests[newIndex]=true}}this.pendingSelections=newRequests},onSelectionsLoad:function(store,records,ranges){this.replaceSelections(records)},hasNext:function(){return this.last!==false&&(this.last+1)<this.grid.store.getTotalCount()},getCount:function(){return this.selections.length+this.getPendingSelections().length},isSelected:function(index){if(typeof index=="number"){var orgInd=index;index=this.grid.store.getAt(orgInd);if(!index){var ind=this.getPendingSelections().indexOf(orgInd);if(ind!=-1){return true}return false}}var r=index;return(r&&this.selections.key(r.id)?true:false)},deselectRecord:function(record,preventViewNotify){if(this.locked){return}var isSelected=this.selections.key(record.id);if(!isSelected){return}var store=this.grid.store;var index=store.indexOfId(record.id);if(index==-1){index=store.findInsertIndex(record);if(index!=Number.MIN_VALUE&&index!=Number.MAX_VALUE){index+=store.bufferRange[0]}}else{delete this.pendingSelections[index]}if(this.last==index){this.last=false}if(this.lastActive==index){this.lastActive=false}this.selections.remove(record);if(!preventViewNotify){this.grid.getView().onRowDeselect(index)}this.fireEvent("rowdeselect",this,index,record);this.fireEvent("selectionchange",this)},deselectRow:function(index,preventViewNotify){if(this.locked){return}if(this.last==index){this.last=false}if(this.lastActive==index){this.lastActive=false}var r=this.grid.store.getAt(index);delete this.pendingSelections[index];if(r){this.selections.remove(r)}if(!preventViewNotify){this.grid.getView().onRowDeselect(index)}this.fireEvent("rowdeselect",this,index,r);this.fireEvent("selectionchange",this)},selectRow:function(index,keepExisting,preventViewNotify){if(this.locked||index<0||index>=this.grid.store.getTotalCount()){return}var r=this.grid.store.getAt(index);if(this.fireEvent("beforerowselect",this,index,keepExisting,r)!==false){if(!keepExisting||this.singleSelect){this.clearSelections()}if(r){this.selections.add(r);delete this.pendingSelections[index]}else{this.pendingSelections[index]=true}this.last=this.lastActive=index;if(!preventViewNotify){this.grid.getView().onRowSelect(index)}this.fireEvent("rowselect",this,index,r);this.fireEvent("selectionchange",this)}},clearPendingSelections:function(startIndex,endIndex){if(endIndex==undefined){endIndex=Number.MAX_VALUE}var newSelections={};var ranges=this.getPendingSelections();var rangesLength=ranges.length;var index=0;for(var i=0;i<rangesLength;i++){index=ranges[i];if(index<=endIndex&&index>=startIndex){continue}newSelections[index]=true}this.pendingSelections=newSelections},replaceSelections:function(records){if(!records||records.length==0){return}var ds=this.grid.store;var rec=null;var assigned=[];var ranges=this.getPendingSelections();var rangesLength=ranges.length;var selections=this.selections;var index=0;for(var i=0;i<rangesLength;i++){index=ranges[i];rec=ds.getAt(index);if(rec){selections.add(rec);assigned.push(rec.id);delete this.pendingSelections[index]}}var id=null;for(i=0,len=records.length;i<len;i++){rec=records[i];id=rec.id;if(assigned.indexOf(id)==-1&&selections.containsKey(id)){selections.add(rec)}}},getPendingSelections:function(asRange){var index=1;var ranges=[];var currentRange=0;var tmpArray=[];for(var i in this.pendingSelections){tmpArray.push(parseInt(i))}tmpArray.sort(function(o1,o2){if(o1>o2){return 1}else{if(o1<o2){return -1}else{return 0}}});if(!asRange){return tmpArray}var max_i=tmpArray.length;if(max_i==0){return[]}ranges[currentRange]=[tmpArray[0],tmpArray[0]];for(var i=0,max_i=max_i-1;i<max_i;i++){if(tmpArray[i+1]-tmpArray[i]==1){ranges[currentRange][1]=tmpArray[i+1]}else{currentRange++;ranges[currentRange]=[tmpArray[i+1],tmpArray[i+1]]}}return ranges},clearSelections:function(fast){if(this.locked){return}if(fast!==true){var ds=this.grid.store;var s=this.selections;var ind=-1;s.each(function(r){ind=ds.indexOfId(r.id);if(ind!=-1){this.deselectRow(ind+ds.bufferRange[0])}},this);s.clear();this.pendingSelections={}}else{this.selections.clear();this.pendingSelections={}}this.last=false},selectRange:function(startRow,endRow,keepExisting){if(this.locked){return}if(!keepExisting){this.clearSelections()}if(startRow<=endRow){for(var i=startRow;i<=endRow;i++){this.selectRow(i,true)}}else{for(var i=startRow;i>=endRow;i--){this.selectRow(i,true)}}}});Ext.namespace("Ext.ux.grid.livegrid");Ext.ux.grid.livegrid.Store=function(config){config=config||{};config.remoteSort=true;this._autoLoad=config.autoLoad?true:false;config.autoLoad=false;this.addEvents("bulkremove","versionchange","beforeselectionsload","selectionsload");Ext.ux.grid.livegrid.Store.superclass.constructor.call(this,config);this.totalLength=0;this.bufferRange=[-1,-1];this.on("clear",function(){this.bufferRange=[-1,-1]},this);if(this.url&&!this.selectionsProxy){this.selectionsProxy=new Ext.data.HttpProxy({url:this.url})}};Ext.extend(Ext.ux.grid.livegrid.Store,Ext.data.Store,{version:null,insert:function(index,records){records=[].concat(records);index=index>=this.bufferSize?Number.MAX_VALUE:index;if(index==Number.MIN_VALUE||index==Number.MAX_VALUE){var l=records.length;if(index==Number.MIN_VALUE){this.bufferRange[0]+=l;this.bufferRange[1]+=l}this.totalLength+=l;this.fireEvent("add",this,records,index);return}var split=false;var insertRecords=records;if(records.length+index>=this.bufferSize){split=true;insertRecords=records.splice(0,this.bufferSize-index)}this.totalLength+=insertRecords.length;if(this.bufferRange[0]<=-1){this.bufferRange[0]=0}if(this.bufferRange[1]<(this.bufferSize-1)){this.bufferRange[1]=Math.min(this.bufferRange[1]+insertRecords.length,this.bufferSize-1)}for(var i=0,len=insertRecords.length;i<len;i++){this.data.insert(index,insertRecords[i]);insertRecords[i].join(this)}while(this.getCount()>this.bufferSize){this.data.remove(this.data.last())}this.fireEvent("add",this,insertRecords,index);if(split==true){this.fireEvent("add",this,records,Number.MAX_VALUE)}},remove:function(record,suspendEvent){var index=this._getIndex(record);if(index<0){this.totalLength-=1;if(this.pruneModifiedRecords){this.modified.remove(record)}this.bufferRange[0]=Math.max(-1,this.bufferRange[0]-1);this.bufferRange[1]=Math.max(-1,this.bufferRange[1]-1);if(suspendEvent!==true){this.fireEvent("remove",this,record,index)}return index}this.bufferRange[1]=Math.max(-1,this.bufferRange[1]-1);this.data.removeAt(index);if(this.pruneModifiedRecords){this.modified.remove(record)}this.totalLength-=1;if(suspendEvent!==true){this.fireEvent("remove",this,record,index)}return index},_getIndex:function(record){var index=this.indexOfId(record.id);if(index<0){index=this.findInsertIndex(record)}return index},bulkRemove:function(records){var rec=null;var recs=[];var ind=0;var len=records.length;var orgIndexes=[];for(var i=0;i<len;i++){rec=records[i];orgIndexes[rec.id]=this._getIndex(rec)}for(var i=0;i<len;i++){rec=records[i];this.remove(rec,true);recs.push([rec,orgIndexes[rec.id]])}this.fireEvent("bulkremove",this,recs)},removeAll:function(){this.totalLength=0;this.bufferRange=[-1,-1];this.data.clear();if(this.pruneModifiedRecords){this.modified=[]}this.fireEvent("clear",this)},loadRanges:function(ranges){var max_i=ranges.length;if(max_i>0&&!this.selectionsProxy.activeRequest&&this.fireEvent("beforeselectionsload",this,ranges)!==false){var lParams=this.lastOptions.params;var params={};params.ranges=Ext.encode(ranges);if(lParams){if(lParams.sort){params.sort=lParams.sort}if(lParams.dir){params.dir=lParams.dir}}var options={};for(var i in this.lastOptions){options.i=this.lastOptions.i}options.ranges=params.ranges;this.selectionsProxy.load(params,this.reader,this.selectionsLoaded,this,options)}},loadSelections:function(ranges){if(ranges.length==0){return}this.loadRanges(ranges)},selectionsLoaded:function(o,options,success){if(this.checkVersionChange(o,options,success)!==false){var r=o.records;for(var i=0,len=r.length;i<len;i++){r[i].join(this)}this.fireEvent("selectionsload",this,o.records,Ext.decode(options.ranges))}else{this.fireEvent("selectionsload",this,[],Ext.decode(options.ranges))}},checkVersionChange:function(o,options,success){if(o&&success!==false){if(o.version!==undefined){var old=this.version;this.version=o.version;if(this.version!==old){return this.fireEvent("versionchange",this,old,this.version)}}}},findInsertIndex:function(record){this.remoteSort=false;var index=Ext.ux.grid.livegrid.Store.superclass.findInsertIndex.call(this,record);this.remoteSort=true;if(this.bufferRange[0]<=0&&index==0){return index}else{if(this.bufferRange[0]>0&&index==0){return Number.MIN_VALUE}else{if(index>=this.bufferSize){return Number.MAX_VALUE}}}return index},sortData:function(f,direction){direction=direction||"ASC";var st=this.fields.get(f).sortType;var fn=function(r1,r2){var v1=st(r1.data[f]),v2=st(r2.data[f]);return v1>v2?1:(v1<v2?-1:0)};this.data.sort(direction,fn)},onMetaChange:function(meta,rtype,o){this.version=null;Ext.ux.grid.livegrid.Store.superclass.onMetaChange.call(this,meta,rtype,o)},loadRecords:function(o,options,success){this.checkVersionChange(o,options,success);if(!o){this.bufferRange=[-1,-1]}else{this.bufferRange=[options.params.start,Math.max(0,Math.min((options.params.start+options.params.limit)-1,o.totalRecords-1))]}if(options.suspendLoadEvent===true){this.suspendEvents()}Ext.ux.grid.livegrid.Store.superclass.loadRecords.call(this,o,options,success);if(options.suspendLoadEvent===true){this.resumeEvents()}},getAt:function(index){if(this.bufferRange[0]==-1){return undefined}var modelIndex=index-this.bufferRange[0];return this.data.itemAt(modelIndex)},clearFilter:function(){},isFiltered:function(){},collect:function(){},createFilterFn:function(){},sum:function(){},filter:function(){},filterBy:function(){},query:function(){},queryBy:function(){},find:function(){},findBy:function(){}});